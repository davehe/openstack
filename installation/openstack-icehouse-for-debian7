

openstack 手动安装手册


部署架构
采用多节点分开部署vlan方式


物理机

ip:eth0:10.1.99.101
Name: controller
vCPU: 8
Memory :16G
Disk:300G



ip:eth0:10.1.99.102  eth1:无ip与交换机对应端口绑trunk     
Name: network
vCPU: 8
Memory :16G
Disk:300G


ip:eth0:10.1.99.104  eth1:无ip与交换机对应端口绑trunk     
Name: compute1
vCPU: 8
Memory :16G
Disk:1T

ip:eth0:10.1.99.106  eth1:无ip与交换机对应端口绑trunk     
Name: compute2
vCPU: 8
Memory :48G
Disk:300G



ip:eth0:10.1.99.105  
Name: cinder
vCPU: 8
Memory :16G
Disk:300G



网络设置

controller
     eth0:10.1.99.101   (management network)
     eht1:(disabled)

network
     eth0:10.1.99.102   (management network)
     eht1:no ip  (private network)

compute1
     eth0:10.1.99.104   (management network)
     eht1:no ip  (private network)

compute2
     eth0:10.1.99.106   (management network)
     eht2:no ip  (private network)
     
cinder
     eth0:10.1.99.105   (management network)
     eht1:(disabled)


network,compute1,compute2 eth1配置
auto eth1
iface eth1 inet manual
    up ip link set dev $IFACE up
    down up link set dev $IFACE down


公共配置

内部已经搭好一套oenpstack源,每台节点上配置/etc/apt/sources.list
deb http://10.1.1.172/debian  wheezy main non-free contrib
deb http://10.1.1.172/openstack_icehouse icehouse main
deb http://10.1.1.172/openstack_icehouse icehouse-backports main

更新并安装key
apt-get update && apt-get install gplhost-archive-keyring

更新升级最新操作系统
apt-get update && apt-get dist-upgrade
reboot

更改hosts配置
10.1.99.101 controller 
10.1.99.102 network
10.1.99.104 compute1
10.1.99.106 compute2
10.1.99.105 cinder


安装ntp服务
apt-get install ntpdate
更改配置文件/etc/default/ntpdate  指定到内网时间服务器10.1.1.10
NTPSERVERS="10.1.1.10"


增加定时任务
*/30 * * * *    /usr/sbin/ntpdate-debian && /sbin/hwclock --directisa -w 


安装python-mysqldb 
apt-get install python-mysqldb






控制节点(contronller) 安装

安装数据库mysql

apt-get install mysql-server

更改配置文件/etc/mysql/my.cnf
[mysqld]
...
bind-address = 10.0.0.11
[mysqld]
...
default-storage-engine = innodb
innodb_file_per_table
collation-server = utf8_general_ci
init-connect = 'SET NAMES utf8'

重启数据库
service mysql restart

删除匿名用户,加强数据库安全性
mysql_install_db
mysql_secure_installation


安装消息服务
apt-get install rabbitmq-server

更改密码
rabbitmqctl change_password guest hc1226


安装keystone服务
apt-get install keystone #会初始化keystone数据库,会为keystone设置admin账户的token

更改keystone用户权限
GRANT ALL PRIVILEGES ON `keystonedb`.* TO 'keystone'@% IDENTIFIED BY 'hc';
GRANT ALL PRIVILEGES ON `keystonedb`.* TO 'keystone'@'%' IDENTIFIED BY 'hc';


设置认证信息
export OS_SERVICE_TOKEN=hc
export OS_SERVICE_ENDPOINT=http://controller:35357/v2.0

创建管理员和系统服务使用的租户
keystone tenant-create --name=admin --description="Admin Tenant"
keystone tenant-create --name=service --description="Service Tenant"

创建管理员用户
keystone user-create --name=admin --pass=admin --email=admin@example.com

创建管理员角色
keystone role-create --name=admin

为管理员用户分配管理员角色
keystone user-role-add --user=admin --tenant=admin --role=admin

为keystone服务建立service
keystone service-create --name=keystone --type=identity --description="Keystone Identity Service"

为keystone建立service和endpoint关联
keystone endpoint-create \
--service-id=$(keystone service-list | awk '/ identity / {print $2}') \
--publicurl=http://controller:5000/v2.0 \
--internalurl=http://controller:5000/v2.0 \
--adminurl=http://controller:35357/v2.0


验证keystone安装的正确性
取消先前的Token变量，不然会干扰新建用户的验证。
unset OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT


用命令行方式验证
keystone --os-username=admin --os-password=admin --os-auth-url=http://controller:35357/v2.0 token-get
keystone --os-username=admin --os-password=admin --os-tenant-name=admin --os-auth-url=http://controller:35357/v2.0 token-get


写入环境变量配置
export OS_USERNAME=admin
export OS_PASSWORD=admin
export OS_TENANT_NAME=admin
export OS_AUTH_URL=http://controller:35357/v2.0


加载环境变量
source admin-openrc.sh

测试
keystone token-get



























